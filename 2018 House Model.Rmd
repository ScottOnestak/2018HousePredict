---
title: "2018 House Model"
author: "Scott Onestak"
date: "October 7, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(dplyr)
library(h2o)
library(glmnet)
```

```{r read in data file}
options(scipen=999)
theData = read.csv("C:/Users/onest/Desktop/2018 House Model/Data Files/Dataset20181009.csv")
theData$ActAdjPVI = ifelse(theData$year==2008,theData$PVI-10.7,
                           ifelse(theData$year==2010,theData$PVI+6.8,
                                  ifelse(theData$year==2012,theData$PVI-1.2,
                                         ifelse(theData$year==2014,theData$PVI+5.7,
                                                ifelse(theData$year==2016,theData$PVI+1.1,theData$AdjPVI)))))

results = read.delim("C:/Users/onest/Desktop/2018 House Model/election data files/1976-2016-house.tab")
results = results %>% filter(year>= 2006)
```

```{r two party results}
twoparty = theData %>% filter(!is.na(GOP_Candidate) & !is.na(Dem_Candidate),year<2018) %>%
  select(name,State,District,CD_Name,year,GOP_Result,Dem_Result)

twoparty$GOP_Base = ifelse(twoparty$year==2008,twoparty$GOP_Result-(-10.7/2),
                           ifelse(twoparty$year==2010,twoparty$GOP_Result-(6.8/2),
                                  ifelse(twoparty$year==2012,twoparty$GOP_Result-(-1.2/2),
                                         ifelse(twoparty$year==2014,twoparty$GOP_Result-(5.7/2),
                                                ifelse(twoparty$year==2016,twoparty$GOP_Result-(1.1/2),"")))))

twoparty$Dem_Base = ifelse(twoparty$year==2008,twoparty$Dem_Result+(-10.7/2),
                           ifelse(twoparty$year==2010,twoparty$Dem_Result+(6.8/2),
                                  ifelse(twoparty$year==2012,twoparty$Dem_Result+(-1.2/2),
                                         ifelse(twoparty$year==2014,twoparty$Dem_Result-+(5.7/2),
                                                ifelse(twoparty$year==2016,twoparty$Dem_Result+(1.1/2),"")))))
twoparty$time = ifelse(twoparty$year<=2010,"old","new")

twoparty$GOP_Base = as.numeric(twoparty$GOP_Base)
twoparty$Dem_Base = as.numeric(twoparty$Dem_Base)

baselines = twoparty %>% group_by(State,District,CD_Name,time) %>%
  summarise(GOP_Base = mean(GOP_Base),
            Dem_Base = mean(Dem_Base),
            count = n()) %>%
  mutate(Gap_Base = GOP_Base - Dem_Base)

```


```{r districts polled by cluster}
test = theData
test$count = 1
test$polled = ifelse(is.na(test$AvgPollsterRating_Polling),0,1)

theData = theData %>% left_join(.,test[,c(1,134)],by="name")

polled = test %>% filter(polled==1) %>%
  group_by(Cluster,year) %>%
  summarise(count = sum(count))

```

#ATTACH PRIOR YEAR ELECTION RESULTS
```{r election results}
TotalNonBlankVotes = results %>% filter(!candidate %in% c(""," ","Blank Vote/Scattering","Blank Vote/Void Vote/Scattering","Void Vote","scatter","Blank Vote")) %>%
  select(year,state_po,district,candidatevotes) %>%
  group_by(year,state_po,district) %>%
  summarise(TotalVotes = sum(candidatevotes))
GOPVotes = results %>% filter(party %in% c("republican") & writein==FALSE) %>%
  select(year,state_po,district,candidatevotes,candidate) %>%
  group_by(year,state_po,district,candidate) %>%
  summarise(candidatevotes = sum(candidatevotes)) %>%
  group_by(year,state_po,district) %>%
  filter(candidatevotes == max(candidatevotes)) %>%
  select(year,state_po,district,GOP_Votes = candidatevotes)
DemVotes = results %>% filter(party %in% c("democrat","democratic-farmer-labor","working families") & writein==FALSE) %>%
  select(year,state_po,district,candidatevotes,candidate) %>%
  group_by(year,state_po,district,candidate) %>%
  summarise(candidatevotes = sum(candidatevotes)) %>%
  group_by(year,state_po,district) %>%
  filter(candidatevotes == max(candidatevotes)) %>%
  select(year,state_po,district,Dem_Votes = candidatevotes)
GOPVotes[GOPVotes == 0] = 1
DemVotes[DemVotes == 0] = 1
TotalNonBlankVotes[TotalNonBlankVotes == 0] = 1
Prior = TotalNonBlankVotes %>% full_join(.,GOPVotes,by=c("year","state_po","district")) %>%
  full_join(.,DemVotes,by=c("year","state_po","district")) %>%
  mutate(GOP_Prct = GOP_Votes / TotalVotes * 100,
         Dem_Prct = Dem_Votes / TotalVotes * 100)

PVIs = Prior %>% select(year,State=state_po,District=district) %>%
  full_join(.,theData,by=c("year","State","District")) %>%
  select(year,State,District,PVI,AdjPVI,ActAdjPVI) %>% 
  filter(year < 2018)
PVIs2006 = PVIs %>% filter(year == 2006) %>% select(year,State,District)
PVIs = PVIs %>% filter(year != 2006)

PVIs2006 = PVIs2006 %>% mutate(year_join = 2008) %>%
  left_join(.,PVIs,by=c("year_join"="year","State"="State","District"="District"))
PVIs2006$AdjPVI = PVIs2006$PVI - 12.926
PVIs2006$ActAdjPVI = PVIs2006$PVI - 7.9
PVIs2006 = PVIs2006[,-c(4)]

PVIs2010 = PVIs %>% filter(year == 2014)
PVIs = PVIs %>% filter(year != 2010)
PVIs2010$year = 2010
PVIs = rbind(PVIs,PVIs2006)
PVIs = rbind(PVIs,PVIs2010)
colnames(PVIs)[4:6] = c("PVI_old","AdjPVI_old","ActAdjPVI_old")
PVIs$year = PVIs$year + 2

Votes = Prior %>% filter(!is.na(GOP_Votes) & !is.na(Dem_Votes)) %>%
  filter(year != 2010) %>% 
  filter(!state_po %in% c("NC","FL") | (state_po %in% c("NC","FL") & year != 2014)) %>%
  filter(!state_po == "PA" | (state_po == "PA" & year != 2016))
Votes$year = Votes$year + 2
Votes2010 = Votes %>% filter(year == 2016)
Votes2010$year = 2012
Votes = rbind(Votes,Votes2010)
colnames(Votes)[2] = "State"
colnames(Votes)[3] = "District"


AllCDs = theData[,c(1,2,3,5,27,30)] %>% 
  left_join(.,Votes,by=c("State","District","year")) %>%
  left_join(.,PVIs,by=c("State","District","year"))

ChallengerCDs = AllCDs %>% filter(!is.na(GOP_Candidate)&!is.na(Dem_Candidate))
ChalKnown = ChallengerCDs %>% filter(!is.na(GOP_Prct))
ChalUnknown = ChallengerCDs %>% filter(is.na(GOP_Prct))

Matches = read.csv("C:/Users/onest/Desktop/2018 House Model/CDsMatch.csv")

ChalUnknown = ChalUnknown %>% left_join(.,Matches[,-c(2,3,4,12,13)],by="name")

ChalUnknown$GOP1 = NA
ChalUnknown$GOP2 = NA
ChalUnknown$GOP3 = NA
ChalUnknown$GOP4 = NA
ChalUnknown$GOP5 = NA
ChalUnknown$GOP6 = NA
ChalUnknown$GOP7 = NA
ChalUnknown$GOP8 = NA
ChalUnknown$GOP9 = NA
ChalUnknown$GOP10 = NA

ChalUnknown$Dem1 = NA
ChalUnknown$Dem2 = NA
ChalUnknown$Dem3 = NA
ChalUnknown$Dem4 = NA
ChalUnknown$Dem5 = NA
ChalUnknown$Dem6 = NA
ChalUnknown$Dem7 = NA
ChalUnknown$Dem8 = NA
ChalUnknown$Dem9 = NA
ChalUnknown$Dem10 = NA

ChalUnknown$PVI1 = NA
ChalUnknown$PVI2 = NA
ChalUnknown$PVI3 = NA
ChalUnknown$PVI4 = NA
ChalUnknown$PVI5 = NA
ChalUnknown$PVI6 = NA
ChalUnknown$PVI7 = NA
ChalUnknown$PVI8 = NA
ChalUnknown$PVI9 = NA
ChalUnknown$PVI10 = NA

ChalKnown$name = as.character(ChalKnown$name)
ChalUnknown$name = as.character(ChalUnknown$name)
ChalUnknown$name1 = as.character(ChalUnknown$name1)
ChalUnknown$name2 = as.character(ChalUnknown$name2)
ChalUnknown$name3 = as.character(ChalUnknown$name3)
ChalUnknown$name4 = as.character(ChalUnknown$name4)
ChalUnknown$name5 = as.character(ChalUnknown$name5)
ChalUnknown$name6 = as.character(ChalUnknown$name6)
ChalUnknown$name7 = as.character(ChalUnknown$name7)
ChalUnknown$name8 = as.character(ChalUnknown$name8)
ChalUnknown$name9 = as.character(ChalUnknown$name9)
ChalUnknown$name10 = as.character(ChalUnknown$name10)

for(i in seq(from=1,to=dim(ChalUnknown)[1],by=1)){
  for(j in seq(from=1,to=dim(ChalKnown)[1],by=1)){
    if(ChalUnknown[i,42]==ChalKnown[j,1]){
      ChalUnknown[i,52] = ChalKnown[j,10]
      ChalUnknown[i,62] = ChalKnown[j,11]
      ChalUnknown[i,72] = ChalKnown[j,12]
    } else if(ChalUnknown[i,43]==ChalKnown[j,1]){
      ChalUnknown[i,53] = ChalKnown[j,10]
      ChalUnknown[i,63] = ChalKnown[j,11]
      ChalUnknown[i,73] = ChalKnown[j,12]
    } else if(ChalUnknown[i,44]==ChalKnown[j,1]){
      ChalUnknown[i,54] = ChalKnown[j,10]
      ChalUnknown[i,64] = ChalKnown[j,11]
      ChalUnknown[i,74] = ChalKnown[j,12]
    } else if(ChalUnknown[i,45]==ChalKnown[j,1]){
      ChalUnknown[i,55] = ChalKnown[j,10]
      ChalUnknown[i,65] = ChalKnown[j,11]
      ChalUnknown[i,75] = ChalKnown[j,12]
    } else if(ChalUnknown[i,46]==ChalKnown[j,1]){
      ChalUnknown[i,56] = ChalKnown[j,10]
      ChalUnknown[i,66] = ChalKnown[j,11]
      ChalUnknown[i,76] = ChalKnown[j,12]
    } else if(ChalUnknown[i,47]==ChalKnown[j,1]){
      ChalUnknown[i,57] = ChalKnown[j,10]
      ChalUnknown[i,67] = ChalKnown[j,11]
      ChalUnknown[i,77] = ChalKnown[j,12]
    } else if(ChalUnknown[i,48]==ChalKnown[j,1]){
      ChalUnknown[i,58] = ChalKnown[j,10]
      ChalUnknown[i,68] = ChalKnown[j,11]
      ChalUnknown[i,78] = ChalKnown[j,12]
    } else if(ChalUnknown[i,49]==ChalKnown[j,1]){
      ChalUnknown[i,59] = ChalKnown[j,10]
      ChalUnknown[i,69] = ChalKnown[j,11]
      ChalUnknown[i,79] = ChalKnown[j,12]
    } else if(ChalUnknown[i,50]==ChalKnown[j,1]){
      ChalUnknown[i,60] = ChalKnown[j,10]
      ChalUnknown[i,70] = ChalKnown[j,11]
      ChalUnknown[i,80] = ChalKnown[j,12]
    } else if(ChalUnknown[i,51]==ChalKnown[j,1]){
      ChalUnknown[i,61] = ChalKnown[j,10]
      ChalUnknown[i,71] = ChalKnown[j,11]
      ChalUnknown[i,81] = ChalKnown[j,12]
    }
  }
}

```

#READ IN TEST SET
```{r test set - aka, the most recent dataset}
testing_data = read.csv("C:/Users/onest/Desktop/2018 House Model/Data Files/Dataset20181009.csv")
testing_data$ActAdjPVI = ifelse(testing_data$year==2008,testing_data$PVI-10.7,
                           ifelse(testing_data$year==2010,testing_data$PVI+6.8,
                                  ifelse(testing_data$year==2012,testing_data$PVI-1.2,
                                         ifelse(testing_data$year==2014,testing_data$PVI+5.7,
                                                ifelse(testing_data$year==2016,testing_data$PVI+1.1,testing_data$AdjPVI)))))
testing_data = testing_data %>% filter(year==2018) %>% 
  left_join(.,currAttach,by="name") %>%
  mutate(AdjPVI_chg = AdjPVI - AdjPVI_old,
         ActAdjPVI_chg = ActAdjPVI - ActAdjPVI_old)

modelingCDs = testing_data %>% filter(!is.na(GOP_Prct))
nonCompCDs = testing_data %>% filter(is.na(GOP_Prct))

nonCompCDs$GOPWin = ifelse(is.na(nonCompCDs$GOP_Candidate),0,1)
```

```{r analyze cluster swings}
modelingCDs2008 = modeldata %>% filter(year == 2016) %>% 
  mutate(Gap = GOP_Result - Dem_Result,GapDiff = Gap - Gap_Prct) %>%
  select(State,District,year,GOP_Result,Dem_Result,Gap,GOP_Prct,Dem_Prct,Gap_Prct,GapDiff,prev_comp,Cluster)

mean(modelingCDs2008[modelingCDs2008$Cluster==1&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==2&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==3&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==4&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==5&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==6&modelingCDs2008$prev_comp==0,]$GapDiff)
mean(modelingCDs2008[modelingCDs2008$Cluster==7&modelingCDs2008$prev_comp==0,]$GapDiff)
```

#IMPUTE POLLING FOR UNPOLLED DISTRICTS
```{r impute polling}
polledCDs = modeldata %>% filter(!is.na(GOP_Polling))
unpolledCDs = modeldata %>% filter(is.na(GOP_Polling))

polledCDs$Undec_Polling = 100 - polledCDs$GOP_Polling - polledCDs$Dem_Polling
polledCDs$weight = polledCDs$NumberOfPolls * polledCDs$AvgPollsterRating_Polling
polledCDs$weight = ifelse(polledCDs$weight>8,8,polledCDs$weight) / 8

polledCDs$AdjGOP_Polling = (polledCDs$weight * (polledCDs$GOP_Polling + ((50+polledCDs$ActAdjPVI)/100)*polledCDs$Undec_Polling)) +
  ((1-polledCDs$weight)*polledCDs$GOP_Prct + .5 * polledCDs$ActAdjPVI_chg)
polledCDs$AdjDem_Polling = (polledCDs$weight* (polledCDs$Dem_Polling + ((50-polledCDs$ActAdjPVI)/100)*polledCDs$Undec_Polling)) +
  ((1-polledCDs$weight)*polledCDs$Dem_Prct - .5 * polledCDs$ActAdjPVI_chg)

#remove high leverage points and outliers
model = lm(AdjGOP_Polling ~ GOP_Prct,data=polledCDs)
summary(model)
influence = influence.measures(model)
hat = influence$infmat[,6]
boxplot_info = boxplot.stats(hat, coef = 1.5, do.out = TRUE)
outliers = boxplot_info$out
min_outlier = min(outliers)

DFFITS = influence$infmat[,3]
DFFITS_classifications = DFFITS
DFFITS_influential = 2 * sqrt((2+1)/(length(DFFITS) - 2 - 1))

for(i in seq(1:length(DFFITS))){
  if(abs(DFFITS[i]) >= DFFITS_influential){
    if(DFFITS[i] < 0){
      DFFITS_classifications[i] = 1 #blue triange
    } else {
      DFFITS_classifications[i] = 2 #green triangle
    }
  } else {
    DFFITS_classifications[i] = 3 #black circle (default)
  }
}

cov = influence$infmat[,4]
cov_class = cov
cov_influence = (3*2) / length(cov)

for(i in seq(1:length(cov))){
  if(abs(cov[i]-1) >= cov_influence){
    if(cov[i] < 1){
      cov_class[i] = 1 #blue triangle
    } else {
      cov_class[i] = 2 #green triangle
    }
  } else {
    cov_class[i] = 3 #black circle (default)
  }
}

plot(polledCDs$GOP_Prct,polledCDs$AdjGOP_Polling, pch=20)
par(new = TRUE)
plot(polledCDs$GOP_Prct,polledCDs$AdjGOP_Polling, pch = c(2,2,20)[as.numeric(DFFITS_classifications)] , col = c('blue','green','black')[as.numeric(DFFITS_classifications)])
par(new = TRUE)
plot(polledCDs$GOP_Prct,polledCDs$AdjGOP_Polling, pch = c(6,6,20)[as.numeric(cov_class)] , col = c('blue','green','black')[as.numeric(cov_class)])
par(new = TRUE)
plot(polledCDs$GOP_Prct,polledCDs$AdjGOP_Polling, pch = 20, col = 1 + (hat >= min_outlier))
abline(model,col='red',lwd=4)

polledCDs$hat = influence$infmat[,6]
polledCDs$DFFITS = influence$infmat[,3]
polledCDs$cov = influence$infmat[,4]
polledCDs$drop = 0

for(i in seq(from=1,to=dim(polledCDs)[1],by=1)){
  if(polledCDs[i,150]>=min_outlier){
    polledCDs[i,153] = 1
  }
  if(abs(polledCDs[i,151]) >= DFFITS_influential){
    polledCDs[i,153] = 1
  } 
  if(abs(polledCDs[i,152]-1) >= cov_influence){
    polledCDs[i,153] = 1
  }
}

#model 2
model2 = lm(AdjGOP_Polling ~ ActAdjPVI,data=polledCDs)
summary(model2)
influence = influence.measures(model2)
hat = influence$infmat[,6]
boxplot_info = boxplot.stats(hat, coef = 1.5, do.out = TRUE)
outliers = boxplot_info$out
min_outlier = min(outliers)

DFFITS = influence$infmat[,3]
DFFITS_classifications = DFFITS
DFFITS_influential = 2 * sqrt((2+1)/(length(DFFITS) - 2 - 1))

for(i in seq(1:length(DFFITS))){
  if(abs(DFFITS[i]) >= DFFITS_influential){
    if(DFFITS[i] < 0){
      DFFITS_classifications[i] = 1 #blue triange
    } else {
      DFFITS_classifications[i] = 2 #green triangle
    }
  } else {
    DFFITS_classifications[i] = 3 #black circle (default)
  }
}

cov = influence$infmat[,4]
cov_class = cov
cov_influence = (3*2) / length(cov)

for(i in seq(1:length(cov))){
  if(abs(cov[i]-1) >= cov_influence){
    if(cov[i] < 1){
      cov_class[i] = 1 #blue triangle
    } else {
      cov_class[i] = 2 #green triangle
    }
  } else {
    cov_class[i] = 3 #black circle (default)
  }
}

plot(polledCDs$ActAdjPVI,polledCDs$AdjGOP_Polling, pch=20)
par(new = TRUE)
plot(polledCDs$ActAdjPVI,polledCDs$AdjGOP_Polling, pch = c(2,2,20)[as.numeric(DFFITS_classifications)] , col = c('blue','green','black')[as.numeric(DFFITS_classifications)])
par(new = TRUE)
plot(polledCDs$ActAdjPVI,polledCDs$AdjGOP_Polling, pch = c(6,6,20)[as.numeric(cov_class)] , col = c('blue','green','black')[as.numeric(cov_class)])
par(new = TRUE)
plot(polledCDs$ActAdjPVI,polledCDs$AdjGOP_Polling, pch = 20, col = 1 + (hat >= min_outlier))
abline(model2,col='red',lwd=4)

polledCDs$hat = influence$infmat[,6]
polledCDs$DFFITS = influence$infmat[,3]
polledCDs$cov = influence$infmat[,4]

for(i in seq(from=1,to=dim(polledCDs)[1],by=1)){
  if(polledCDs[i,150]>=min_outlier){
    polledCDs[i,153] = 1
  }
  if(abs(polledCDs[i,151]) >= DFFITS_influential){
    polledCDs[i,153] = 1
  } 
  if(abs(polledCDs[i,152]-1) >= cov_influence){
    polledCDs[i,153] = 1
  }
}

regbuild = polledCDs %>% filter(drop==0)

model2 = lm(AdjGOP_Polling ~ ActAdjPVI + GOP_Prct + Gap_Prct + President + ActAdjPVI_old + GOP_Incumbent + Dem_Incumbent + BachGrad + MedianIncome + Evangelical + Catholic + Veteran + White,data=regbuild)
summary(model2)
plot(regbuild$ActAdjPVI,regbuild$AdjGOP_Polling, pch=20)

```


























#REDUCE FEATURS FOR NAIVE BAYES AND LINEAR REGRESSION MODELS
```{r lasso}
pred = modeldata[,29]
vars = modeldata[,c(6:26,28,31,33:120,126:132,134:136)]

#lasso
lasso = cv.glmnet(vars,pred)

```

#BUILD THE MODEL
```{r model building}
#create training and test sets for final model
train_set = modeldata[,c(1,6:26,28,31,33:132,134:136)]
test_set = modelingCDs[,c(1,6:26,28,31,33:135)]

train_set$winner = as.factor(train_set$winner)
test_set$winner = as.factor(test_set$winner)
#h2o connection 
h2o.init(nthreads=-1,max_mem_size='6G')

train = as.h2o(train_set)
test = as.h2o(test_set)

train.split <- h2o.splitFrame(train, seed = 111)
train.train <- train.split[[1]]
train.calib <- train.split[[2]]

y = "winner"
x = setdiff(names(train),c(y,"name"))

rf = h2o.randomForest(x = x,
                      y = y,
                      training_frame = train.train,
                      ntrees = 250,
                      nfolds = 10,
                      fold_assignment = "Modulo",
                      keep_cross_validation_predictions = TRUE,
                      calibrate_model = T,
                      calibration_frame = train.calib,
                      seed = 111)
test_results = h2o.predict(rf, newdata = test)
test_set$results = as.data.frame(test_results$p1)
test_set$results2 = as.data.frame(test_results$cal_p1)
see_results = test_set[,c(1,128,129)]

gb = h2o.gbm(x = x,
            y = y,
            training_frame = train,
            ntrees = 50,
            max_depth = 20,
            min_rows = 2,
            learn_rate = 0.2,
            nfolds = 10,
            fold_assignment = "Modulo",
            calibrate_model = T,
            keep_cross_validation_predictions = TRUE,
            seed = 1)

ensemble = h2o.stackedEnsemble(x = x,
                                y = y,
                                training_frame = train,
                                model_id = "my_ensemble",
                                base_models = list(rf,gb))





lr = h2o.glm(x = x,
             y = y,
             training_frame = train,
             family = binomial,
             nfolds = 10,
             fold_assignment = "Modulo",
             keep_cross_validation_predictions = TRUE,
             seed = 111)

nb = h2o.naiveBayes(x = x,
                    y = y,
                    training_frame = train,
                    nfolds = 10,
                    fold_assignment = "Modulo",
                    keep_cross_validation_predictions = TRUE,
                    seed = 111)

```


